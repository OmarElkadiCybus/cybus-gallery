description: >
  BACnet write with input format transformation.
  Shows converting standard HVAC commands to BACnet object writes
  for controlling building automation systems.

metadata:
  name: BACnet Write with Transformation
  provider: cybus
  homepage: https://www.cybus.io
  version: 1.0.0

parameters:
  deviceInstance:
    type: number
    default: 2000
    
  deviceAddress:
    type: string
    default: "192.168.1.50:47808"

resources:
  bacnetConnection:
    type: Cybus::Connection
    properties:
      protocol: Bacnet
      connection:
        deviceInstance: !ref deviceInstance
        deviceAddress: !ref deviceAddress
        localPort: 48808

  # Write temperature setpoint
  temperatureSetpointWrite:
    type: Cybus::Endpoint
    properties:
      protocol: Bacnet
      connection: !ref bacnetConnection
      write:
        objectType: "analog-value"
        objectInstance: 5
        property: "present-value"
      topic: bacnet/setpoint/write

  # Write HVAC control
  hvacControlWrite:
    type: Cybus::Endpoint
    properties:
      protocol: Bacnet
      connection: !ref bacnetConnection
      write:
        objectType: "binary-output"
        objectInstance: 10
        property: "present-value"
      topic: bacnet/hvac/control/write

  # Transform standard input to BACnet formats
  commandTransformation:
    type: Cybus::Mapping
    properties:
      mappings:
      
      # Convert temperature setpoint to BACnet format
      - subscribe:
          topic: building/hvac/setpoint
        publish:
          endpoint: !ref temperatureSetpointWrite
        rules:
        - transform:
            expression: |
              /* Convert standard HVAC setpoint to BACnet */
              /* Input: {"temperature_celsius": 22.5, "zone": "conference_room"} */
              /* Output: 22.5 (BACnet analog value) */
              $.temperature_celsius

      # Convert HVAC control command to BACnet binary
      - subscribe:
          topic: building/hvac/control
        publish:
          endpoint: !ref hvacControlWrite
        rules:
        - transform:
            expression: |
              /* Convert HVAC control to BACnet binary */
              /* Input: {"fan_enable": true, "system": "heating"} */
              /* Output: true/false (BACnet binary value) */
              $.fan_enable

# Input Format Examples:
#
# 1. Temperature Setpoint:
#    Input: {"temperature_celsius": 22.5, "zone": "conference_room"}
#    BACnet Output: 22.5 → analog-value object 5
#
# 2. HVAC Control:
#    Input: {"fan_enable": true, "system": "heating"}
#    BACnet Output: true → binary-output object 10

# Key Concepts:
# ✅ BACnet Objects: Writing to analog-value and binary-output objects
# ✅ Simple Mapping: Direct value extraction from JSON to BACnet
# ✅ HVAC Control: Standard building automation commands
# ✅ Temperature Control: Standard setpoint management